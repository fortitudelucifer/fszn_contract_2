{% extends 'base.html' %}

{% block title %}操作日志{% endblock %}

{% block content %}
<h1>
    操作日志
    {% if current_contract %}
    - 合同 {{ current_contract.project_code }}（ID={{ current_contract.id }}）
    {% endif %}
</h1>

{% if current_contract %}
<p>
    当前合同：
    {{ current_contract.project_code }} - {{ current_contract.name }}
    （ID={{ current_contract.id }}）
</p>
{% endif %}

<form method="get" style="margin-bottom: 1em;">
    <div>
        <label>动作(action)：</label>
        <input type="text" name="action" value="{{ filters.action or '' }}">
    </div>
    <div>
        <label>目标类型(target_type)：</label>
        <input type="text" name="target_type" value="{{ filters.target_type or '' }}">
    </div>
    <div>
        <label>目标ID(target_id)：</label>
        <input type="text" name="target_id" value="{{ filters.target_id or '' }}">
    </div>
    <div>
        <label>用户ID(user_id)：</label>
        <input type="text" name="user_id" value="{{ filters.user_id or '' }}">
    </div>
    <div>
        <label>关键字(q)：</label>
        <input type="text" name="q" value="{{ filters.q or '' }}" placeholder="在说明 / extra_data 中搜索">
    </div>
    <div>
        <label>开始日期(start_date)：</label>
        <input type="date" name="start_date" value="{{ filters.start_date or '' }}">
    </div>
    <div>
        <label>结束日期(end_date)：</label>
        <input type="date" name="end_date" value="{{ filters.end_date or '' }}">
    </div>
    <div style="margin-top: 0.5em;">
        <button type="submit">筛选</button>
        <a href="{{ url_for('contracts.operation_logs') }}">重置</a>
        {% if current_contract %}
        <!-- 返回当前合同的日志页（保持原有入口不变） -->
        <a href="{{ url_for('contracts.contract_operation_logs', contract_id=current_contract.id) }}">仅看该合同</a>
        {% endif %}
    </div>
</form>

{% if rows %}
<table border="1" cellpadding="4" cellspacing="0">
    <thead>
        <tr>
            <th>操作时间</th>
            <th>用户</th>
            <th>操作类型</th>
            <th>目标</th>
            <th>说明</th>
            <th>额外信息</th>
        </tr>
    </thead>
    <tbody>
        {% for row in rows %}
        {% set log = row.log %}
        <tr>
            <td>
                {% if log.created_at %}
                {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% endif %}
            </td>
            <td>
                {% if row.user %}
                {{ row.user.username }}（ID={{ row.user.id }}）
                {% elif log.user_id %}
                用户ID={{ log.user_id }}
                {% else %}
                -
                {% endif %}
            </td>
            <td>{{ log.action }}</td>
            <td>
                {{ log.target_type or '' }}
                {% if log.target_id %}
                #{{ log.target_id }}
                {% endif %}
            </td>
            <td>{{ log.message or '' }}</td>
            <td>
                {% if row.extra %}
                <div>
                    {% for k, v in row.extra.items() %}
                    {% if v is not none and v != '' %}
                    <div>{{ k }}：{{ v }}</div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if pagination %}
<div style="margin-top: 1em;">
    <span>
        第 {{ pagination.page }} / {{ pagination.total_pages }} 页，
        共 {{ pagination.total }} 条记录
    </span>
    {% if pagination.has_prev %}
    <a href="{{ url_for('contracts.operation_logs',
                            page=pagination.page - 1,
                            action=filters.action,
                            target_type=filters.target_type,
                            target_id=filters.target_id,
                            user_id=filters.user_id,
                            q=filters.q,
                            start_date=filters.start_date,
                            end_date=filters.end_date) }}">上一页</a>
    {% endif %}
    {% if pagination.has_next %}
    <a href="{{ url_for('contracts.operation_logs',
                            page=pagination.page + 1,
                            action=filters.action,
                            target_type=filters.target_type,
                            target_id=filters.target_id,
                            user_id=filters.user_id,
                            q=filters.q,
                            start_date=filters.start_date,
                            end_date=filters.end_date) }}">下一页</a>
    {% endif %}
</div>
{% endif %}
{% else %}
<p>当前没有符合条件的操作记录。</p>
{% endif %}

{% endblock %}
