{% extends 'base.html' %}

{% block title %}项目 / 合同列表{% endblock %}

{% block content %}
<h1>项目 / 合同列表</h1>

<form method="get" style="margin: 0 0 1em 0;">
    <div style="margin-bottom: 0.5em;">
        客户公司：
        <input type="text" name="company" value="{{ company_kw or '' }}" style="width: 120px;">

        项目编号：
        <input type="text" name="project" value="{{ project_kw or '' }}" style="width: 120px;">

        合同编号：
        <input type="text" name="contract_no" value="{{ contract_no_kw or '' }}" style="width: 120px;">
    </div>

    <div style="margin-bottom: 0.5em;">
        销售：
        <input type="text" name="sales" value="{{ sales_kw or '' }}" style="width: 100px;">

        部门负责人：
        <input type="text" name="leader" value="{{ leader_kw or '' }}" style="width: 100px;">

        状态：
        <select name="status">
            <option value="">全部</option>
            <option value="not_started" {{ 'selected' if status_param == 'not_started' }}>未启动</option>
            <option value="in_production" {{ 'selected' if status_param == 'in_production' }}>生产中</option>
            <option value="accepted_pending_payment" {{ 'selected' if status_param == 'accepted_pending_payment' }}>已验收，待回款</option>
            <option value="paid_with_issues" {{ 'selected' if status_param == 'paid_with_issues' }}>已回款，有未解决问题</option>
            <option value="finished" {{ 'selected' if status_param == 'finished' }}>已完成</option>
        </select>
    </div>

    <div style="margin-bottom: 0.5em;">
        排序：
        <select name="order">
            <option value="" {{ 'selected' if not order_param }}>按创建时间（新→旧）</option>
            <option value="created_at_asc" {{ 'selected' if order_param == 'created_at_asc' }}>按创建时间（旧→新）</option>
            <option value="deal_date_desc" {{ 'selected' if order_param == 'deal_date_desc' }}>按成交日期（新→旧）</option>
            <option value="deal_date_asc" {{ 'selected' if order_param == 'deal_date_asc' }}>按成交日期（旧→新）</option>
            <option value="status_asc" {{ 'selected' if order_param == 'status_asc' }}>按状态（A→Z）</option>
            <option value="status_desc" {{ 'selected' if order_param == 'status_desc' }}>按状态（Z→A）</option>
        </select>

        <button type="submit">搜索 / 筛选</button>
        <a href="{{ url_for('contracts.list_contracts') }}">重置</a>
    </div>
</form>

<p>
    <a href="{{ url_for('contracts.new_contract') }}">新建项目/合同</a>
</p>

{% if contracts %}

<table border="1" cellpadding="4" cellspacing="0">
    <thead>
        <tr>
            <th>ID</th>
            <th>客户公司</th>
            <th>项目编号</th>
            <th>合同编号</th>
            <th>合同名称</th>
            <th>计划交付时间</th>  <!-- 新增 -->
            <th>客户负责人</th>
            <th>客户联系方式</th>
            <th>我方负责人</th>
            <th>状态</th>
            <th>部门及负责人</th>
            <th>销售概要</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for c in contracts %}
        <tr>
            <td>{{ c.id }}</td>
            <td>{{ c.company.name if c.company else '' }}</td>
            <td>{{ c.project_code }}</td>
            <td>{{ c.contract_number }}</td>
            <td>
                <a href="{{ url_for('contracts.manage_tasks', contract_id=c.id) }}">
                    {{ c.name }}
                </a>
            </td>
            <td>
                <form method="post"
                      action="{{ url_for('contracts.set_planned_delivery', contract_id=c.id) }}">
                    <input type="date"
                           name="planned_delivery_date"
                           value="{{ c.planned_delivery_date.strftime('%Y-%m-%d') if c.planned_delivery_date else '' }}">
                    <button type="submit">保存</button>
                </form>
            </td>
            <td>{{ c.client_manager }}</td>
            <td>{{ c.client_contact }}</td>
            <td>{{ c.our_manager }}</td>
            {# ========= 彩色状态展示 ========= #}
            <td>
                {% set st = statuses.get(c.id) %}
                {% if st %}
                {% if st.level == 'green' %}
                <span style="color:green;">{{ st.text }}</span>
                {% elif st.level == 'red' %}
                <span style="color:red;">{{ st.text }}</span>
                {% elif st.level == 'orange' %}
                <span style="color:darkorange;">{{ st.text }}</span>
                {% elif st.level == 'blue' %}
                <span style="color:blue;">{{ st.text }}</span>
                {% else %}
                <span style="color:#666;">{{ st.text }}</span>
                {% endif %}
                {% else %}
                -
                {% endif %}
            </td>

            {# ========= 部门及负责人 ========= #}
            <td>
                {% set dept_map = leaders_by_contract.get(c.id, {}) %}
                {% if dept_map %}
                {% for dept, persons in dept_map.items() %}
                <div>
                    <strong>{{ dept }}：</strong>
                    {% for p in persons %}
                    {{ p.name }}{% if not loop.last %}，{% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
                {% else %}
                暂无
                {% endif %}
            </td>

            {# 销售信息概要 #}
            <td>
                {% if c.sales_info %}
                报价：{{ c.sales_info.quote_amount or '未填' }}<br>
                报价日：{{ c.sales_info.quote_date or '未填' }}<br>
                成交日：{{ c.sales_info.deal_date or '未填' }}<br>
                销售：{{ c.sales_info.sales_person.name if c.sales_info.sales_person else '未指定' }}
                {% else %}
                暂无
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('contracts.contract_overview', contract_id=c.id) }}">总览</a> |
                <a href="{{ url_for('contracts.manage_sales', contract_id=c.id) }}">销售</a> |
                <a href="{{ url_for('contracts.manage_leaders', contract_id=c.id) }}">负责人</a> |
                <a href="{{ url_for('contracts.manage_tasks', contract_id=c.id) }}">任务</a> |
                <a href="{{ url_for('contracts.manage_procurements', contract_id=c.id) }}">采购</a> |
                <a href="{{ url_for('contracts.manage_acceptances', contract_id=c.id) }}">验收</a> |
                <a href="{{ url_for('contracts.manage_payments', contract_id=c.id) }}">付款</a> |
                <a href="{{ url_for('contracts.manage_invoices', contract_id=c.id) }}">开票</a> |
                <a href="{{ url_for('contracts.manage_refunds', contract_id=c.id) }}">退款</a> |
                <a href="{{ url_for('contracts.manage_feedbacks', contract_id=c.id) }}">客户反馈</a> |
                <a href="{{ url_for('contracts.manage_files', contract_id=c.id) }}">文件</a> |
                <form method="post"
                      action="{{ url_for('contracts.delete_contract', contract_id=c.id) }}"
                      style="display:inline;"
                      onsubmit="return confirm('确定要删除该合同及所有关联记录吗？此操作不可恢复。');">
                    <button type="submit">删除该合同</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>

</table>
  {% else %}
<p>当前还没有项目/合同。</p>
  {% endif %}
{% endblock %}
